<template>
  <div class="grid grid-cols-1 2xl:grid-cols-2 gap-4">
    <!-- Á´ôÂè∞È¢ÑËßà -->
    <div class="mb-6">
      <div class="flex justify-between items-center mb-3">
        <h4 class="text-sm font-medium">Á´ôÂè∞Â∏ÉÂ±ÄÈ¢ÑËßà</h4>

        <!-- È¢ÑËßàÊéßÂà∂ÈÄâÈ°π -->
        <div class="flex items-center gap-4">
          <!-- ËΩ¶ÂûãÈÄâÊã© -->
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-600">È¢ÑËßàËΩ¶Âûã:</span>
            <el-select
              v-model="selectedTrainType"
              size="small"
              placeholder="ÈÄâÊã©ËΩ¶Âûã"
              style="width: 120px"
            >
              <el-option label="E235-0Á≥ª" value="E235-0" />
              <!-- Êú™Êù•ËΩ¶ÂûãÈ¢ÑÁïô -->
              <!-- <el-option label="E235-1000Á≥ª" value="E235-1000" disabled /> -->
            </el-select>
          </div>

          <!-- Â±èÂπï‰æßËæπ -->
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-600">Â±èÂπï‰æß:</span>
            <el-select
              v-model="previewScreenSide"
              size="small"
              placeholder="ÈÄâÊã©‰æßËæπ"
              style="width: 80px"
            >
              <el-option label="Â∑¶‰æß" value="Left" />
              <el-option label="Âè≥‰æß" value="Right" />
            </el-select>
          </div>

          <!-- ËΩ¶Âé¢ÁºñÂè∑ÊñπÂêë -->
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-600">ÁºñÂè∑ÊñπÂêë:</span>
            <el-select
              v-model="previewCarNumberDirection"
              size="small"
              placeholder="ÈÄâÊã©ÊñπÂêë"
              style="width: 80px"
            >
              <el-option label="Ê≠£Âêë" value="Front" />
              <el-option label="ÂèçÂêë" value="Opposite" />
            </el-select>
          </div>

          <!-- ÂΩìÂâçËΩ¶Âé¢ -->
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-600">ÂΩìÂâçËΩ¶Âé¢:</span>
            <el-select
              v-model="previewCurrentCarNumber"
              size="small"
              placeholder="ÈÄâÊã©ËΩ¶Âé¢"
              style="width: 80px"
              clearable
            >
              <el-option
                v-for="carNum in 11"
                :key="carNum"
                :label="`${carNum}Âè∑`"
                :value="carNum"
              />
            </el-select>
          </div>
        </div>
      </div>

      <!-- E235-0 È¢ÑËßàÁªÑ‰ª∂ -->
      <PlatformPreviewE235_0
        v-if="selectedTrainType === 'E235-0'"
        :platform="platform"
        :exits="exits"
        :screen-side="previewScreenSide"
        :car-number-direction="previewCarNumberDirection"
        :current-car-number="previewCurrentCarNumber"
        :canvas-width="1920"
        @object-click="handleObjectClick"
        @object-hover="handleObjectHover"
      />

      <!-- Êú™Êù•ÂÖ∂‰ªñËΩ¶ÂûãÁªÑ‰ª∂È¢ÑÁïô‰ΩçÁΩÆ -->
      <!-- <PlatformPreviewE235_1000 v-else-if="selectedTrainType === 'E235-1000'" ... /> -->

      <!-- Êú™Áü•ËΩ¶ÂûãÊèêÁ§∫ -->
      <div
        v-if="!['E235-0'].includes(selectedTrainType)"
        class="flex items-center justify-center h-32 text-gray-400 border-2 border-dashed border-gray-300 rounded"
      >
        <div class="text-center">
          <div class="text-2xl mb-2">üöÖ</div>
          <div class="text-sm">ÊöÇ‰∏çÊîØÊåÅÊ≠§ËΩ¶ÂûãÈ¢ÑËßà</div>
        </div>
      </div>
    </div>

    <el-form label-position="top" class="h-128 overflow-auto">
      <div class="grid grid-cols-[3fr_1fr] gap-4 mb-4">
        <el-form-item label="Êó•ÊñáÂêçÁß∞">
          <el-input
            :model-value="platform.name.kanji"
            @input="updateName('kanji', $event)"
          />
        </el-form-item>
        <el-form-item label="ËΩ¶Èó®ÂºÄÂêØÊñπÂêë">
          <el-select
            :model-value="platform.doorside"
            @change="updateDoorside($event)"
          >
            <el-option label="Â∑¶‰æß" value="Left" />
            <el-option label="Âè≥‰æß" value="Right" />
          </el-select>
        </el-form-item>
      </div>

      <!-- Âá∫Âè£ÊòæÁ§∫ÁÆ°ÁêÜ -->
      <el-form-item label="Âá∫Âè£ÊòæÁ§∫">
        <div class="space-y-4 w-full">
          <div
            v-for="(exitDisplay, exitIndex) in (platform.exits || [])"
            :key="exitIndex"
            class="border border-gray-200 rounded p-4"
          >
            <div class="flex justify-between items-center mb-3">
              <h4 class="font-medium">Âá∫Âè£ÊòæÁ§∫ {{ exitIndex + 1 }}</h4>
              <el-button
                type="danger"
                size="small"
                @click="removeExitDisplay(exitIndex)"
              >
                Âà†Èô§Âá∫Âè£ÊòæÁ§∫
              </el-button>
            </div>

            <div class="grid grid-cols-[2fr_1fr_1fr_1fr_1fr] gap-2 mb-3">
              <el-form-item label="ÂÖ≥ËÅîÂá∫Âè£">
                <el-select
                  :model-value="exitDisplay.id"
                  @change="updateExitDisplayId(exitIndex, $event)"
                >
                  <el-option
                    v-for="exit in exits"
                    :key="exit.id"
                    :label="`Âá∫Âè£ ${exit.id}: ${exit.name.kanji}`"
                    :value="exit.id"
                  />
                </el-select>
              </el-form-item>

              <el-form-item label="Ëµ∑ÂßãXÂùêÊ†á">
                <el-input-number
                  :model-value="exitDisplay.start"
                  :min="0"
                  :max="Math.min(exitDisplay.end - 1, 934)"
                  class="!w-full"
                  @update:model-value="updateExitDisplayStart(exitIndex, $event)"
                />
              </el-form-item>

              <el-form-item label="ÁªìÊùüXÂùêÊ†á">
                <el-input-number
                  :model-value="exitDisplay.end"
                  :min="exitDisplay.start + 1"
                  :max="935"
                  class="!w-full"
                  @update:model-value="updateExitDisplayEnd(exitIndex, $event)"
                />
              </el-form-item>

              <el-form-item label="ÊñáÂ≠óÂ∞∫ÂØ∏">
                <el-input-number
                  :model-value="exitDisplay.fontScale"
                  :min="0.1"
                  :max="3"
                  :step="0.1"
                  class="!w-full"
                  @update:model-value="updateExitDisplayFontScale(exitIndex, $event)"
                />
              </el-form-item>

              <el-form-item label="ÂûÇÁõ¥ÂØπÈΩê">
                <el-select
                  :model-value="exitDisplay.av"
                  @change="updateExitDisplayPos(exitIndex, $event)"
                >
                  <el-option label="Á´ôÂè∞Ëøë‰æß" value="Front" />
                  <el-option label="Á´ôÂè∞‰∏≠ÈÉ®" value="Center" />
                  <el-option label="Á´ôÂè∞Ëøú‰æß" value="Back" />
                  <el-option label="Á´ôÂè∞ÁïåÂ§ñ" value="Border" />
                </el-select>
              </el-form-item>
            </div>
          </div>

          <el-button
            type="primary"
            size="small"
            @click="addExitDisplay"
          >
            Ê∑ªÂä†Âá∫Âè£ÊòæÁ§∫
          </el-button>
        </div>
      </el-form-item>

      <!-- Á´ôÂè∞ÂçïÂÖÉÁÆ°ÁêÜ -->
      <el-form-item label="Á´ôÂè∞ÂçïÂÖÉ">
        <div class="space-y-4 w-full">
          <div
            v-for="(unit, unitIndex) in (platform.units || [])"
            :key="unitIndex"
            class="border border-gray-200 rounded p-4"
          >
            <div class="flex justify-between items-center mb-3">
              <h4 class="font-medium">ÂçïÂÖÉ {{ unitIndex + 1 }}</h4>
              <el-button
                type="danger"
                size="small"
                @click="removeUnit(unitIndex)"
              >
                Âà†Èô§ÂçïÂÖÉ
              </el-button>
            </div>

            <!-- Á´ôÂè∞ÂØπË±°ÁÆ°ÁêÜ -->
            <div class="mt-4">
              <div class="flex justify-between items-center mb-2">
                <h5 class="text-sm font-medium">Á´ôÂè∞ÂØπË±°</h5>
                <el-button
                  type="primary"
                  size="small"
                  @click="addObject(unitIndex)"
                >
                  Ê∑ªÂä†ÂØπË±°
                </el-button>
              </div>

              <div
                v-for="(object, objectIndex) in unit.objects"
                :key="objectIndex"
                class="border border-gray-100 rounded p-3 mb-2"
              >
                <div class="flex gap-2 items-center mb-2">
                  <el-select
                    :model-value="object.type"
                    placeholder="Á±ªÂûã"
                    class="w-32"
                    @change="updateObjectType(unitIndex, objectIndex, $event)"
                  >
                    <el-option label="‰∏ãË°åÊ•ºÊ¢Ø" value="DownStairs" />
                    <el-option label="‰∏äË°åÊ•ºÊ¢Ø" value="UpStairs" />
                    <el-option label="‰∏ãË°åÊâ∂Ê¢Ø" value="DownEscalator" />
                    <el-option label="‰∏äË°åÊâ∂Ê¢Ø" value="UpEscalator" />
                    <el-option label="ÁîµÊ¢Ø" value="Elevator" />
                  </el-select>

                  <el-select
                    :model-value="object.direction"
                    placeholder="ÊñπÂêë"
                    class="w-24"
                    @change="updateObjectDirection(unitIndex, objectIndex, $event)"
                  >
                    <el-option label="ÊúùÂêëËΩ¶Â§¥" value="Front" />
                    <el-option label="ÊúùÂêëËΩ¶Â∞æ" value="Opposite" />
                  </el-select>

                  <el-select
                    :model-value="object.ah"
                    placeholder="‰ΩçÁΩÆ"
                    class="w-24"
                    @change="updateObjectAh(unitIndex, objectIndex, $event)"
                  >
                    <el-option label="ÂØπÈΩêËΩ¶Â§¥6" value="Front6" />
                    <el-option label="ÂØπÈΩêËΩ¶Â§¥5" value="Front5" />
                    <el-option label="ÂØπÈΩêËΩ¶Â§¥4" value="Front4" />
                    <el-option label="ÂØπÈΩêËΩ¶Â§¥3" value="Front3" />
                    <el-option label="ÂØπÈΩêËΩ¶Â§¥2" value="Front2" />
                    <el-option label="ÂØπÈΩêËΩ¶Â§¥1" value="Front1" />
                    <el-option label="ÂØπÈΩêËΩ¶Â§¥" value="Front" />
                    <el-option label="ÂØπÈΩê‰∏≠Èó¥" value="Center" />
                    <el-option label="ÂØπÈΩêËΩ¶Â∞æ" value="Back" />
                    <el-option label="ÂØπÈΩêËΩ¶Â∞æ1" value="Back1" />
                    <el-option label="ÂØπÈΩêËΩ¶Â∞æ2" value="Back2" />
                    <el-option label="ÂØπÈΩêËΩ¶Â∞æ3" value="Back3" />
                    <el-option label="ÂØπÈΩêËΩ¶Â∞æ4" value="Back4" />
                    <el-option label="ÂØπÈΩêËΩ¶Â∞æ5" value="Back5" />
                    <el-option label="ÂØπÈΩêËΩ¶Â∞æ6" value="Back6" />
                  </el-select>

                  <el-select
                    :model-value="object.av"
                    placeholder="‰ΩçÁΩÆ"
                    class="w-24"
                    @change="updateObjectAv(unitIndex, objectIndex, $event)"
                  >
                    <el-option label="Á´ôÂè∞Ëøë‰æß" value="Front" />
                    <el-option label="Á´ôÂè∞‰∏≠ÈÉ®" value="Center" />
                    <el-option label="Á´ôÂè∞Ëøú‰æß" value="Back" />
                  </el-select>

                  <el-select
                    :model-value="object.linkedExit"
                    placeholder="ÂÖ≥ËÅîÂá∫Âè£"
                    class="w-32"
                    clearable
                    @change="updateObjectLinkedExit(unitIndex, objectIndex, $event)"
                  >
                    <el-option
                      v-for="exit in exits"
                      :key="exit.id"
                      :label="`Âá∫Âè£ ${exit.id}: ${exit.name.kanji}`"
                      :value="exit.id"
                    />
                  </el-select>

                  <el-button
                    type="danger"
                    size="small"
                    @click="removeObject(unitIndex, objectIndex)"
                  >
                    Âà†Èô§
                  </el-button>
                </div>
              </div>
            </div>
          </div>

          <el-button
            type="primary"
            size="small"
            @click="addUnit"
          >
            Ê∑ªÂä†ÂçïÂÖÉ
          </el-button>
        </div>
      </el-form-item>

      <el-button type="danger" size="small" @click="$emit('delete')">
        Âà†Èô§Á´ôÂè∞
      </el-button>
    </el-form>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import type { Exit, Platform, PlatformObject, ExitDisplay } from '../../../../../types/station'
import PlatformPreviewE235_0 from '../../themes/E235-0/PlatformPreviewE235-0.vue'
import {
  ElForm,
  ElFormItem,
  ElInput,
  ElInputNumber,
  ElSelect,
  ElOption,
  ElButton
} from 'element-plus'

interface Props {
  platform: Platform
  exits: Exit[]
}

interface Emits {
  (e: 'update', platform: Platform): void
  (e: 'delete'): void
}

const props = defineProps<Props>()
const emit = defineEmits<Emits>()

// ËΩ¶ÂûãÈÄâÊã©Áõ∏ÂÖ≥
const selectedTrainType = ref<string>('E235-0')

// È¢ÑËßàÊéßÂà∂ÂèòÈáè
const previewScreenSide = ref<'Left' | 'Right'>('Left')
const previewCarNumberDirection = ref<'Front' | 'Opposite'>('Front')
const previewCurrentCarNumber = ref<number | undefined>(undefined)

// È¢ÑËßàÂØπË±°Á±ªÂûãÂÆö‰πâÔºà‰∏é E235-0 ÁªÑ‰ª∂‰øùÊåÅ‰∏ÄËá¥Ôºâ
interface DrawableObject {
  id: string
  type: PlatformObject['type']
  direction: PlatformObject['direction']
  pos: PlatformObject['ah']
  unitIndex: number
  x: number
  y: number
  width: number
  height: number
  stackIndex: number      // Êñ∞Â¢ûÔºöÂú®Â†ÜÂè†‰∏≠ÁöÑÁ¥¢Âºï
  totalInStack: number    // Êñ∞Â¢ûÔºöÊÄªÂ†ÜÂè†Êï∞Èáè
}

// ÂØπË±°‰∫§‰∫íÂ§ÑÁêÜ
function handleObjectClick(object: DrawableObject) {
  console.log('ÁÇπÂáª‰∫ÜËÆæÊñΩÂØπË±°:', object)
  // Êú™Êù•ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ÂØπË±°ÁºñËæëÈÄªËæë
}

function handleObjectHover(object: DrawableObject | null) {
  // Êú™Êù•ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ÊÇ¨ÂÅúÁä∂ÊÄÅÈÄªËæë
  if (object) {
    console.log('ÊÇ¨ÂÅúÂú®ËÆæÊñΩ‰∏ä:', object)
  }
}

function updateName(field: keyof Platform['name'], value: string) {
  const updatedPlatform = {
    ...props.platform,
    name: {
      ...props.platform.name,
      [field]: value
    }
  }
  emit('update', updatedPlatform)
}

function updateDoorside(value: 'Left' | 'Right') {
  const updatedPlatform = {
    ...props.platform,
    doorside: value
  }
  emit('update', updatedPlatform)
}

// Âá∫Âè£ÊòæÁ§∫ÁÆ°ÁêÜÂáΩÊï∞
function addExitDisplay() {
  const newExitDisplay: ExitDisplay = {
    id: props.exits && props.exits.length > 0 ? props.exits[0].id : 1,
    start: 0,
    end: 935,
    av: 'Border',
    fontScale: 1
  }

  const updatedPlatform = {
    ...props.platform,
    exits: [...(props.platform.exits || []), newExitDisplay]
  }
  emit('update', updatedPlatform)
}

function removeExitDisplay(exitIndex: number) {
  const updatedPlatform = {
    ...props.platform,
    exits: (props.platform.exits || []).filter((_, index) => index !== exitIndex)
  }
  emit('update', updatedPlatform)
}

function updateExitDisplayId(exitIndex: number, exitId: number) {
  const updatedPlatform = {
    ...props.platform,
    exits: (props.platform.exits || []).map((exitDisplay, index) =>
      index === exitIndex ? { ...exitDisplay, id: exitId } : exitDisplay
    )
  }
  emit('update', updatedPlatform)
}

function updateExitDisplayStart(exitIndex: number, start: number | undefined) {
  if (start === undefined) return

  const updatedPlatform = {
    ...props.platform,
    exits: (props.platform.exits || []).map((exitDisplay, index) =>
      index === exitIndex ? { ...exitDisplay, start } : exitDisplay
    )
  }
  emit('update', updatedPlatform)
}

function updateExitDisplayEnd(exitIndex: number, end: number | undefined) {
  if (end === undefined) return

  const updatedPlatform = {
    ...props.platform,
    exits: (props.platform.exits || []).map((exitDisplay, index) =>
      index === exitIndex ? { ...exitDisplay, end } : exitDisplay
    )
  }
  emit('update', updatedPlatform)
}

function updateExitDisplayFontScale(exitIndex: number, fontScale: number | undefined) {
  if (fontScale === undefined) return

  const updatedPlatform = {
    ...props.platform,
    exits: (props.platform.exits || []).map((exitDisplay, index) =>
      index === exitIndex ? { ...exitDisplay, fontScale } : exitDisplay
    )
  }
  emit('update', updatedPlatform)
}

function updateExitDisplayPos(exitIndex: number, pos: ExitDisplay['av']) {
  const updatedPlatform = {
    ...props.platform,
    exits: (props.platform.exits || []).map((exitDisplay, index) =>
      index === exitIndex ? { ...exitDisplay, av: pos } : exitDisplay
    )
  }
  emit('update', updatedPlatform)
}

// Á´ôÂè∞ÂçïÂÖÉÁÆ°ÁêÜÂáΩÊï∞
function addUnit() {
  const newUnit = {
    objects: []
  }

  const updatedPlatform = {
    ...props.platform,
    units: [...(props.platform.units || []), newUnit]
  }
  emit('update', updatedPlatform)
}

function removeUnit(unitIndex: number) {
  const updatedPlatform = {
    ...props.platform,
    units: (props.platform.units || []).filter((_, index) => index !== unitIndex)
  }
  emit('update', updatedPlatform)
}

// Á´ôÂè∞ÂØπË±°ÁÆ°ÁêÜÂáΩÊï∞
function addObject(unitIndex: number) {
  const newObject: PlatformObject = {
    type: 'DownStairs',
    direction: 'Front',
    ah: 'Center',
    av: 'Front',
    linkedExit: undefined
  }

  const updatedPlatform = {
    ...props.platform,
    units: (props.platform.units || []).map((unit, index) =>
      index === unitIndex
        ? { ...unit, objects: [...unit.objects, newObject] }
        : unit
    )
  }
  emit('update', updatedPlatform)
}

function removeObject(unitIndex: number, objectIndex: number) {
  const updatedPlatform = {
    ...props.platform,
    units: (props.platform.units || []).map((unit, uIndex) =>
      uIndex === unitIndex
        ? { ...unit, objects: unit.objects.filter((_, oIndex) => oIndex !== objectIndex) }
        : unit
    )
  }
  emit('update', updatedPlatform)
}

function updateObjectType(unitIndex: number, objectIndex: number, type: PlatformObject['type']) {
  const updatedPlatform = {
    ...props.platform,
    units: (props.platform.units || []).map((unit, uIndex) =>
      uIndex === unitIndex
        ? {
            ...unit,
            objects: unit.objects.map((obj, oIndex) =>
              oIndex === objectIndex ? { ...obj, type } : obj
            )
          }
        : unit
    )
  }
  emit('update', updatedPlatform)
}

function updateObjectDirection(unitIndex: number, objectIndex: number, direction: PlatformObject['direction']) {
  const updatedPlatform = {
    ...props.platform,
    units: (props.platform.units || []).map((unit, uIndex) =>
      uIndex === unitIndex
        ? {
            ...unit,
            objects: unit.objects.map((obj, oIndex) =>
              oIndex === objectIndex ? { ...obj, direction } : obj
            )
          }
        : unit
    )
  }
  emit('update', updatedPlatform)
}

function updateObjectAh(unitIndex: number, objectIndex: number, ah: PlatformObject['ah']) {
  const updatedPlatform = {
    ...props.platform,
    units: (props.platform.units || []).map((unit, uIndex) =>
      uIndex === unitIndex
        ? {
            ...unit,
            objects: unit.objects.map((obj, oIndex) =>
              oIndex === objectIndex ? { ...obj, ah: ah } : obj
            )
          }
        : unit
    )
  }
  emit('update', updatedPlatform)
}

function updateObjectAv(unitIndex: number, objectIndex: number, av: PlatformObject['av']) {
  const updatedPlatform = {
    ...props.platform,
    units: (props.platform.units || []).map((unit, uIndex) =>
      uIndex === unitIndex
        ? {
            ...unit,
            objects: unit.objects.map((obj, oIndex) =>
              oIndex === objectIndex ? { ...obj, av: av } : obj
            )
          }
        : unit
    )
  }
  emit('update', updatedPlatform)
}

function updateObjectLinkedExit(unitIndex: number, objectIndex: number, linkedExit: number | undefined) {
  const updatedPlatform = {
    ...props.platform,
    units: (props.platform.units || []).map((unit, uIndex) =>
      uIndex === unitIndex
        ? {
            ...unit,
            objects: unit.objects.map((obj, oIndex) =>
              oIndex === objectIndex ? { ...obj, linkedExit } : obj
            )
          }
        : unit
    )
  }
  emit('update', updatedPlatform)
}
</script>
